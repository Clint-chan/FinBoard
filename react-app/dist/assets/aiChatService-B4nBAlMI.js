const w="https://market-api.newestgpt.com";function f(){try{const t=localStorage.getItem("market_board_auth");if(t)return JSON.parse(t).token||null}catch{}return null}async function m(){const t=f();if(!t)throw new Error("未登录");const o=await fetch(`${w}/api/user/quota`,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error("获取配额失败");return o.json()}async function A(t,o,g,l="intraday",s){var d;const u=f(),n=await fetch(`${w}/api/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t,stockData:o,mode:l,token:u})});if(!n.ok){if(n.status===429){const r=await n.json();throw new Error(r.error||"今日 AI 使用次数已用完")}try{const r=await n.json();throw new Error(r.error||r.details||"AI 服务暂时不可用")}catch{throw new Error("AI 服务暂时不可用")}}const c=(d=n.body)==null?void 0:d.getReader();if(!c)throw new Error("No response body");const p=new TextDecoder;let i="";for(;;){const{done:r,value:y}=await c.read();if(r)break;const E=p.decode(y,{stream:!0}).split(`
`).filter(a=>a.trim());for(const a of E)if(a.startsWith("data: ")){const h=a.slice(6);if(h==="[DONE]")continue;try{const e=JSON.parse(h);if(e.content&&(i+=e.content,s==null||s(e.content)),e.error)throw new Error(e.error)}catch(e){console.error("Parse error:",e)}}}return i}export{m as getUserQuota,A as sendChatMessage};
