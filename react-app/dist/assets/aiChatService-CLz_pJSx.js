const u="https://market-api.newestgpt.com";async function A(){const r=localStorage.getItem("cloud_token");if(!r)return{quota:3,used:0,remaining:3,isAdmin:!1};const o=await fetch(`${u}/api/user/quota`,{headers:{Authorization:`Bearer ${r}`}});return o.ok?o.json():{quota:3,used:0,remaining:3,isAdmin:!1}}async function I(r,o,m,l="intraday",a){var d;const h=localStorage.getItem("cloud_token"),e=await fetch(`${u}/api/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:r,stockData:o,mode:l,token:h})});if(!e.ok){if(e.status===429){const s=await e.json();throw new Error(s.error||"今日 AI 使用次数已用完")}throw new Error(`AI API error: ${e.status}`)}const i=(d=e.body)==null?void 0:d.getReader();if(!i)throw new Error("No response body");const w=new TextDecoder;let c="";for(;;){const{done:s,value:p}=await i.read();if(s)break;const g=w.decode(p,{stream:!0}).split(`
`).filter(n=>n.trim());for(const n of g)if(n.startsWith("data: ")){const f=n.slice(6);if(f==="[DONE]")continue;try{const t=JSON.parse(f);if(t.content&&(c+=t.content,a==null||a(t.content)),t.error)throw new Error(t.error)}catch(t){console.error("Parse error:",t)}}}return c}export{A as getUserQuota,I as sendChatMessage};
