const h="https://market-api.newestgpt.com";function u(){try{const t=localStorage.getItem("market_board_auth");if(t)return JSON.parse(t).token||null}catch{}return null}async function m(){const t=u();if(!t)throw new Error("未登录");const r=await fetch(`${h}/api/user/quota`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw new Error("获取配额失败");return r.json()}async function A(t,r,E,w="intraday",a){var d;const l=u(),o=await fetch(`${h}/api/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t,stockData:r,mode:w,token:l})});if(!o.ok){if(o.status===429){const s=await o.json();throw new Error(s.error||"今日 AI 使用次数已用完")}throw new Error(`AI API error: ${o.status}`)}const c=(d=o.body)==null?void 0:d.getReader();if(!c)throw new Error("No response body");const p=new TextDecoder;let i="";for(;;){const{done:s,value:y}=await c.read();if(s)break;const g=p.decode(y,{stream:!0}).split(`
`).filter(n=>n.trim());for(const n of g)if(n.startsWith("data: ")){const f=n.slice(6);if(f==="[DONE]")continue;try{const e=JSON.parse(f);if(e.content&&(i+=e.content,a==null||a(e.content)),e.error)throw new Error(e.error)}catch(e){console.error("Parse error:",e)}}}return i}export{m as getUserQuota,A as sendChatMessage};
