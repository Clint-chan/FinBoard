# 日内做T Agent 数据流文档

> 本文档详细说明日内做T（Intraday Trading）AI Agent 的数据采集、处理和传递流程

## 📊 数据流概览

```
用户请求 → 前端 → Worker API → 数据采集 → 数据格式化 → AI 大模型 → 流式响应 → 前端展示
```

---

## 1. 数据采集层

### 1.1 前端传入数据

**来源**: `react-app/src/components/AnalysisDrawer/index.tsx`

**传入字段**:
```typescript
{
  code: "sh600519",      // 股票代码
  name: "贵州茅台",       // 股票名称
  price: 1850.00,        // 当前价格
  preClose: 1840.00,     // 昨收价
  high: 1860.00,         // 今日最高
  low: 1845.00,          // 今日最低
  vol: 12345,            // 成交量
  amt: 2280000000        // 成交额
}
```

**用途**: 提供基础行情数据，用于 AI 分析的上下文

---

### 1.2 Worker 后端采集数据

**位置**: `worker/index.js` - `collectStockData()` 函数

#### 数据源 1: 实时行情
**接口**: `https://push2.eastmoney.com/api/qt/stock/get`

**采集字段**:
- `f58`: 股票名称
- `f43`: 最新价
- `f170`: 涨跌幅
- `f169`: 涨跌额
- `f44`: 最高价
- `f45`: 最低价
- `f46`: 今开
- `f60`: 昨收
- `f171`: 振幅
- `f168`: 换手率
- `f50`: 量比

**数据量**: 1条实时数据

---

#### 数据源 2: 日K线数据
**接口**: `https://push2his.eastmoney.com/api/qt/stock/kline/get`

**参数**:
- `klt`: 101 (日K线)
- `lmt`: 30 (最近30根)

**采集字段**:
- 日期
- 开盘价
- 收盘价
- 最高价
- 最低价
- 成交量

**数据量**: 30根日K线

**用途**: 
- 计算均线（MA5/MA10/MA20）
- 计算MACD指标
- 计算RSI指标
- 分析量价关系
- 确定趋势方向

---

#### 数据源 3: 60分钟K线数据
**接口**: `https://push2his.eastmoney.com/api/qt/stock/kline/get`

**参数**:
- `klt`: 60 (60分钟K线)
- `lmt`: 10 (最近10根)

**采集字段**: 同日K线

**数据量**: 10根60分钟K线

**用途**:
- 判断中期波段趋势
- 确定关键支撑压力位
- 分析日内波动节奏

---

#### 数据源 4: 15分钟K线数据
**接口**: `https://push2his.eastmoney.com/api/qt/stock/kline/get`

**参数**:
- `klt`: 15 (15分钟K线)
- `lmt`: 20 (最近20根)

**采集字段**: 同日K线

**数据量**: 20根15分钟K线

**用途**:
- 寻找精确的进出场点位
- 判断短期趋势转折
- 确定日内高低点

---

#### 数据源 5: 分时数据（可选）
**接口**: `https://push2.eastmoney.com/api/qt/stock/trends2/get`

**参数**:
- `ndays`: 1 (当日)

**采集字段**:
- 时间
- 价格
- 成交量
- 均价

**数据量**: 当日所有分时点（约240个）

**用途**:
- 观察日内价格走势
- 分析上午/下午表现
- 判断价格与均价关系

---

#### 数据源 6: 资金流向数据（可选）
**接口**: `https://push2his.eastmoney.com/api/qt/stock/fflow/daykline/get`

**参数**:
- `lmt`: 5 (最近5天)

**采集字段**:
- 主力净流入（超大单+大单）
- 超大单净流入
- 大单净流入
- 中单净流入
- 小单净流入
- 主力净流入占比

**数据量**: 5天资金流向数据

**用途**:
- 判断主力资金动向
- 分析机构行为
- 评估买卖力量对比

---

## 2. 数据处理层

### 2.1 技术指标计算

**位置**: `worker/index.js` - `calculateIndicators()` 函数

#### 计算的指标

**1. 均线 (MA)**
```javascript
MA5 = 最近5日收盘价平均值
MA10 = 最近10日收盘价平均值
MA20 = 最近20日收盘价平均值
```

**2. MACD**
```javascript
EMA12 = 12日指数移动平均
EMA26 = 26日指数移动平均
DIF = EMA12 - EMA26
DEA = DIF的9日EMA
MACD = (DIF - DEA) * 2
```

**3. RSI**
```javascript
RSI(6) = 6日相对强弱指标
RSI(12) = 12日相对强弱指标
```

**4. ATR (平均真实波幅)**
```javascript
ATR = 最近3日 (最高价 - 最低价) 的平均值
ATR% = ATR / 当前价格 * 100
```

---

### 2.2 数据格式化

**位置**: `worker/index.js` - `collectStockData()` 函数

将采集的原始数据格式化为结构化文本，包含以下章节：

#### 章节 1: 当前状态
```
股票：贵州茅台 (600519)
现价：1850.00 元，涨跌幅：+0.54%
今日高低：1860.00 / 1845.00 元
当前位置：中间
振幅：0.82%，换手率：0.35%，量比：1.12
```

#### 章节 2: 日K线（最近3根）
```
2024-12-12: 涨1.23%, 放量15%
2024-12-13: 跌0.45%, 缩量8%
2024-12-14: 涨0.54%, 缩量12%
```

#### 章节 3: 60分钟K线（最近3根）
```
12-14 10:30: 涨0.32%
12-14 11:30: 跌0.18%
12-14 13:00: 涨0.25%
```

#### 章节 4: 分时走势（如果有）
```
昨收：1840.00，当前均价：1848.50
上午：高1858.00 低1845.00
下午：高1860.00 低1847.00
价格高于均价 1.50 元
```

#### 章节 5: 资金流向（如果有）
```
主力净流入：1250.00万 (5.23%) ✓
超大单：850.00万
大单：400.00万
中单：-650.00万
小单：-600.00万
```

#### 章节 6: 成交量分析
```
今日成交量：1234万手
5日均量：1150万手
量比：107% (正常)
```

#### 章节 7: 波动率
```
近3日ATR：15.20 (0.82%)
波动特征：低波动
```

#### 章节 8: 均线（日K）
```
MA5: 1855.00 跌破
MA10: 1860.00 跌破
MA20: 1870.00 跌破
压力：1870.00，支撑：1855.00
```

#### 章节 9: MACD（日K）
```
绿柱变长
DIF: -0.0012, DEA: -0.0008
```

#### 章节 10: RSI（日K）
```
RSI(6): 45.20
RSI(12): 48.50
```

#### 章节 11: 关键点位
```
日K前高：1875.00，前低：1835.00
60分钟前高：1862.00，前低：1843.00
```

---

## 3. AI 处理层

### 3.1 系统提示词

**位置**: `worker/index.js` - `buildSystemPrompt()` 函数

**模式**: `intraday` (日内做T)

**提示词内容**:
```
你是一位专业的A股短线交易分析师，专注于"日内做T"策略。

你的核心能力：
- 多周期K线分析（日线定方向，60分钟看波段，15分钟找进出点）
- 量价配合判断（放量上涨、缩量回调、放量下跌的含义）
- 技术指标应用（KDJ/RSI超买超卖，MACD背离，均线支撑压力）
- 给出具体的买卖点位、止损止盈和仓位建议

回复要求：
1. 先进行技术分析，给出核心研判
2. 给出具体的操作策略和点位
3. 在回复的最后，必须输出结构化的交易信号数据

[格式化的股票数据]
```

---

### 3.2 消息构建

**完整消息结构**:
```javascript
[
  {
    role: 'system',
    content: '系统提示词 + 格式化的股票数据'
  },
  {
    role: 'user',
    content: '用户的问题'
  }
]
```

---

### 3.3 AI 模型调用

**API**: 配置的 AI API 地址（默认: `https://gpt.newestgpt.com`）

**模型**: 配置的模型名称（默认: `gemini-3-pro-preview-thinking`）

**请求参数**:
```javascript
{
  model: "gemini-3-pro-preview-thinking",
  messages: [...],
  stream: true  // 流式响应
}
```

---

## 4. 响应处理层

### 4.1 流式响应格式

**格式**: Server-Sent Events (SSE)

**数据格式**:
```
data: {"content":"<think>"}
data: {"content":"分析内容..."}
data: {"content":"</think>"}
data: {"content":"正式回复..."}
data: {"content":"<trading_signals>"}
data: {"content":"交易信号JSON"}
data: {"content":"</trading_signals>"}
data: [DONE]
```

---

### 4.2 前端解析

**位置**: `react-app/src/components/AnalysisDrawer/ChatMessage.tsx`

**解析步骤**:

1. **提取思考过程**
   - 查找 `<think>...</think>` 标签
   - 显示在"推理过程"折叠面板中

2. **提取正式回复**
   - 提取 `</think>` 之后、`<trading_signals>` 之前的内容
   - 使用 Markdown 渲染

3. **提取交易信号**
   - 查找 `<trading_signals>...</trading_signals>` 标签
   - 解析 JSON 数据
   - 渲染为交易信号卡片

---

### 4.3 交易信号格式

```json
{
  "code": "600519",
  "name": "贵州茅台",
  "signals": [
    {
      "type": "buy",
      "price": 1845.00,
      "label": "低吸点",
      "action": "below",
      "reason": "回踩MA5支撑"
    },
    {
      "type": "sell",
      "price": 1865.00,
      "label": "高抛点",
      "action": "above",
      "reason": "触及MA20压力"
    },
    {
      "type": "stop",
      "price": 1835.00,
      "label": "止损点",
      "action": "below",
      "reason": "跌破关键支撑"
    }
  ]
}
```

---

## 5. 数据统计

### 总数据量

| 数据类型 | 数量 | 用途 |
|---------|------|------|
| 实时行情 | 1条 | 当前状态 |
| 日K线 | 30根 | 趋势判断、技术指标 |
| 60分钟K线 | 10根 | 波段分析 |
| 15分钟K线 | 20根 | 进出点位 |
| 分时数据 | ~240点 | 日内走势 |
| 资金流向 | 5天 | 主力行为 |

**总计**: 约 306 条时序数据 + 技术指标

---

## 6. 性能优化

### 6.1 并行请求

所有数据源使用 `Promise.all()` 并行请求，减少总耗时：

```javascript
const [rt, dailyKlines, klines60, klines15, intraday, fundFlow] = 
  await Promise.all([...])
```

### 6.2 容错处理

非关键数据（分时、资金流向）使用 `.catch(() => null)` 容错，避免单个接口失败导致整体失败。

### 6.3 数据缓存

前端使用 localStorage 缓存行情数据，实现"秒开"体验。

---

## 7. 数据流示例

### 完整流程示例

```
1. 用户点击"分析"按钮
   ↓
2. 前端发送请求到 Worker
   POST /api/ai/chat
   {
     messages: [{ role: 'user', content: '分析一下当前走势' }],
     stockData: { code: '600519', name: '贵州茅台', ... },
     mode: 'intraday'
   }
   ↓
3. Worker 并行采集数据
   - 实时行情 (100ms)
   - 日K线 (150ms)
   - 60分钟K线 (150ms)
   - 15分钟K线 (150ms)
   - 分时数据 (200ms)
   - 资金流向 (180ms)
   总耗时: ~200ms (并行)
   ↓
4. Worker 格式化数据
   - 计算技术指标 (10ms)
   - 格式化为文本 (5ms)
   ↓
5. Worker 调用 AI 模型
   - 构建消息 (1ms)
   - 发送请求 (流式)
   ↓
6. AI 模型生成回复
   - 思考过程 (2-5秒)
   - 正式回复 (3-8秒)
   - 交易信号 (1-2秒)
   ↓
7. Worker 转发流式响应
   - 实时传输每个 chunk
   ↓
8. 前端解析并展示
   - 思考过程 → 折叠面板
   - 正式回复 → Markdown 渲染
   - 交易信号 → 信号卡片
```

---

## 8. 关键文件索引

| 文件 | 功能 |
|------|------|
| `worker/index.js` | 数据采集、格式化、AI调用 |
| `react-app/src/components/AnalysisDrawer/index.tsx` | 前端聊天界面 |
| `react-app/src/components/AnalysisDrawer/ChatMessage.tsx` | 消息解析和渲染 |
| `react-app/src/components/TradingSignals/index.tsx` | 交易信号卡片 |
| `react-app/src/components/Reasoning/index.tsx` | 推理过程展示 |
| `react-app/src/services/aiChatService.ts` | AI API 调用服务 |

---

## 9. 未来优化方向

1. **增加更多技术指标**: KDJ、布林带、成交量指标
2. **支持更多周期**: 5分钟K线、30分钟K线
3. **增加板块数据**: 所属板块的表现
4. **增加市场情绪**: 北向资金、两融数据
5. **历史回测**: 基于历史数据验证策略有效性

---

**文档版本**: v1.0  
**最后更新**: 2024-12-14  
**维护者**: FinBoard Project
