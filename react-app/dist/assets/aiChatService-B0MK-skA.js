const g="https://market-api.newestgpt.com",i={apiUrl:"http://frp3.ccszxc.site:14266/v1/chat/completions",apiKey:"zxc123",model:"gemini-3-pro-preview-thinking"};async function E(h,r,x,w="intraday",s){var p;const m=w==="intraday"?"你是专业的A股短线交易分析师，专注日内做T策略。基于多周期K线、量价配合、技术指标，给出具体买卖点位、止损止盈和仓位建议。":"";let a="";if(r!=null&&r.code)try{const e=await fetch(`${g}/api/stock/data/${r.code}`);e.ok&&(a=(await e.json()).context||"")}catch(e){console.warn("获取股票数据失败:",e)}const y=[{role:"system",content:m},...h.map((e,o)=>e.role==="user"&&a&&o===0?{role:"user",content:`${a}

${e.content}`}:e)],c=await fetch(i.apiUrl,{method:"POST",headers:{Authorization:`Bearer ${i.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:i.model,messages:y,stream:!0})});if(!c.ok)throw new Error(`AI API error: ${c.status}`);const d=(p=c.body)==null?void 0:p.getReader();if(!d)throw new Error("No response body");const u=new TextDecoder;let l="";for(;;){const{done:e,value:o}=await d.read();if(e)break;const A=u.decode(o,{stream:!0}).split(`
`).filter(n=>n.trim());for(const n of A)if(n.startsWith("data: ")){const f=n.slice(6);if(f==="[DONE]")continue;try{const t=JSON.parse(f);if(t.content&&(l+=t.content,s==null||s(t.content)),t.error)throw new Error(t.error)}catch(t){console.error("Parse error:",t)}}}return l}export{E as sendChatMessage};
