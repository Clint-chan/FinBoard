const h="https://market-api.newestgpt.com";async function P(w,o,E,i="intraday",s){var f;const y=i==="intraday"?"你是专业的A股短线交易分析师，专注日内做T策略。基于多周期K线、量价配合、技术指标，给出具体买卖点位、止损止盈和仓位建议。":"";let a="";if(o!=null&&o.code)try{const e=o.code.replace(/^(sh|sz)/i,""),r=await fetch(`${h}/api/stock/data/${e}`);r.ok&&(a=(await r.json()).context||"")}catch(e){console.warn("获取股票数据失败:",e)}const u=[{role:"system",content:y},...w.map((e,r)=>e.role==="user"&&a&&r===0?{role:"user",content:`${a}

${e.content}`}:e)],c=await fetch(`${h}/api/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:u,mode:i})});if(!c.ok)throw new Error(`AI API error: ${c.status}`);const d=(f=c.body)==null?void 0:f.getReader();if(!d)throw new Error("No response body");const m=new TextDecoder;let l="";for(;;){const{done:e,value:r}=await d.read();if(e)break;const $=m.decode(r,{stream:!0}).split(`
`).filter(n=>n.trim());for(const n of $)if(n.startsWith("data: ")){const p=n.slice(6);if(p==="[DONE]")continue;try{const t=JSON.parse(p);if(t.content&&(l+=t.content,s==null||s(t.content)),t.error)throw new Error(t.error)}catch(t){console.error("Parse error:",t)}}}return l}export{P as sendChatMessage};
