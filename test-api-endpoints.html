<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API æ¥å£æµ‹è¯•</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 10px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      border-left: 4px solid #4CAF50;
    }
    .error {
      border-left: 4px solid #f44336;
      background: #ffebee;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    .curl-command {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª ä¸œæ–¹è´¢å¯Œ API æ¥å£æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>æµ‹è¯•é…ç½®</h2>
    <label>è‚¡ç¥¨ä»£ç : <input type="text" id="stockCode" value="600519" placeholder="600519"></label>
    <label>å¸‚åœº: 
      <select id="market">
        <option value="sh">ä¸Šæµ·(sh)</option>
        <option value="sz">æ·±åœ³(sz)</option>
      </select>
    </label>
  </div>

  <!-- 1. ç›˜å£æ•°æ®æµ‹è¯• -->
  <div class="test-section">
    <h2>1. ç›˜å£æ•°æ®ï¼ˆä¹°å–äº”æ¡£ï¼‰</h2>
    <button onclick="testBidAsk()">æµ‹è¯•ç›˜å£æ¥å£</button>
    <div class="curl-command" id="bidask-curl"></div>
    <div id="bidask-result"></div>
  </div>

  <!-- 2. èµ„é‡‘æµå‘æµ‹è¯• -->
  <div class="test-section">
    <h2>2. èµ„é‡‘æµå‘ï¼ˆä¸»åŠ›/å¤§å•/ä¸­å•/å°å•ï¼‰</h2>
    <button onclick="testFundFlow()">æµ‹è¯•èµ„é‡‘æµå‘æ¥å£</button>
    <div class="curl-command" id="fundflow-curl"></div>
    <div id="fundflow-result"></div>
  </div>

  <!-- 3. åˆ†æ—¶æˆäº¤æ˜ç»†æµ‹è¯• -->
  <div class="test-section">
    <h2>3. åˆ†æ—¶æˆäº¤æ˜ç»†ï¼ˆé€ç¬”æ•°æ®ï¼‰</h2>
    <button onclick="testTickData()">æµ‹è¯•æˆäº¤æ˜ç»†æ¥å£</button>
    <div class="curl-command" id="tick-curl"></div>
    <div id="tick-result"></div>
  </div>

  <!-- 4. ç»¼åˆæµ‹è¯• -->
  <div class="test-section">
    <h2>4. ç»¼åˆæµ‹è¯•ï¼ˆæ‰€æœ‰æ¥å£ï¼‰</h2>
    <button onclick="testAll()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <div id="all-result"></div>
  </div>

  <script>
    function getStockCode() {
      return document.getElementById('stockCode').value;
    }

    function getMarket() {
      return document.getElementById('market').value;
    }

    function getMarketCode(symbol) {
      return symbol.startsWith('6') ? 1 : 0;
    }

    function showResult(elementId, data, isError = false) {
      const el = document.getElementById(elementId);
      el.className = `result ${isError ? 'error' : 'success'}`;
      el.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    function showLoading(elementId) {
      const el = document.getElementById(elementId);
      el.className = 'result';
      el.innerHTML = '<div class="loading">â³ åŠ è½½ä¸­...</div>';
    }

    function showCurl(elementId, url, params) {
      const el = document.getElementById(elementId);
      const fullUrl = `${url}?${params.toString()}`;
      el.textContent = `curl "${fullUrl}"`;
    }

    // æµ‹è¯•ç›˜å£æ•°æ®
    async function testBidAsk() {
      const symbol = getStockCode();
      const marketCode = getMarketCode(symbol);
      const url = 'https://push2.eastmoney.com/api/qt/stock/get';
      const params = new URLSearchParams({
        fltt: '2',
        invt: '2',
        fields: 'f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f31,f32,f33,f34,f35,f36,f37,f38,f39,f40,f43,f49,f161',
        secid: `${marketCode}.${symbol}`
      });

      showCurl('bidask-curl', url, params);
      showLoading('bidask-result');

      try {
        const response = await fetch(`${url}?${params}`);
        const data = await response.json();
        
        if (!data.data) {
          throw new Error('æ— æ•°æ®è¿”å›');
        }

        const d = data.data;
        const result = {
          ä¹°ç›˜: [
            { ä¹°ä¸€: d.f19, é‡: d.f20 * 100 },
            { ä¹°äºŒ: d.f17, é‡: d.f18 * 100 },
            { ä¹°ä¸‰: d.f15, é‡: d.f16 * 100 },
            { ä¹°å››: d.f13, é‡: d.f14 * 100 },
            { ä¹°äº”: d.f11, é‡: d.f12 * 100 }
          ],
          å–ç›˜: [
            { å–ä¸€: d.f39, é‡: d.f40 * 100 },
            { å–äºŒ: d.f37, é‡: d.f38 * 100 },
            { å–ä¸‰: d.f35, é‡: d.f36 * 100 },
            { å–å››: d.f33, é‡: d.f34 * 100 },
            { å–äº”: d.f31, é‡: d.f32 * 100 }
          ],
          æœ€æ–°ä»·: d.f43,
          å¤–ç›˜: d.f49,
          å†…ç›˜: d.f161,
          åŸå§‹æ•°æ®: data.data
        };

        showResult('bidask-result', result);
      } catch (error) {
        showResult('bidask-result', { error: error.message }, true);
      }
    }

    // æµ‹è¯•èµ„é‡‘æµå‘
    async function testFundFlow() {
      const symbol = getStockCode();
      const marketCode = getMarketCode(symbol);
      const url = 'https://push2his.eastmoney.com/api/qt/stock/fflow/daykline/get';
      const params = new URLSearchParams({
        lmt: '5',
        klt: '101',
        secid: `${marketCode}.${symbol}`,
        fields1: 'f1,f2,f3,f7',
        fields2: 'f51,f52,f53,f54,f55,f56,f57,f58,f59,f60,f61,f62,f63,f64,f65',
        ut: 'b2884a393a59ad64002292a3e90d46a5',
        _: Date.now()
      });

      showCurl('fundflow-curl', url, params);
      showLoading('fundflow-result');

      try {
        const response = await fetch(`${url}?${params}`);
        const data = await response.json();
        
        if (!data.data?.klines) {
          throw new Error('æ— æ•°æ®è¿”å›');
        }

        const klines = data.data.klines;
        const latest = klines[klines.length - 1].split(',');
        
        const result = {
          æœ€è¿‘5å¤©æ•°æ®: klines.map(line => {
            const parts = line.split(',');
            return {
              æ—¥æœŸ: parts[0],
              ä¸»åŠ›å‡€æµå…¥: parseFloat(parts[1]),
              å°å•å‡€æµå…¥: parseFloat(parts[2]),
              ä¸­å•å‡€æµå…¥: parseFloat(parts[3]),
              å¤§å•å‡€æµå…¥: parseFloat(parts[4]),
              è¶…å¤§å•å‡€æµå…¥: parseFloat(parts[5]),
              ä¸»åŠ›å‡€æµå…¥å æ¯”: parseFloat(parts[6]) + '%'
            };
          }),
          ä»Šæ—¥æ•°æ®: {
            æ—¥æœŸ: latest[0],
            ä¸»åŠ›å‡€æµå…¥: parseFloat(latest[1]),
            ä¸»åŠ›å‡€æµå…¥å æ¯”: parseFloat(latest[6]) + '%',
            è¶…å¤§å•å‡€æµå…¥: parseFloat(latest[5]),
            å¤§å•å‡€æµå…¥: parseFloat(latest[4]),
            ä¸­å•å‡€æµå…¥: parseFloat(latest[3]),
            å°å•å‡€æµå…¥: parseFloat(latest[2])
          },
          åŸå§‹æ•°æ®: data.data
        };

        showResult('fundflow-result', result);
      } catch (error) {
        showResult('fundflow-result', { error: error.message }, true);
      }
    }

    // æµ‹è¯•åˆ†æ—¶æˆäº¤æ˜ç»†
    async function testTickData() {
      const symbol = getStockCode();
      const marketCode = getMarketCode(symbol);
      const url = 'https://70.push2.eastmoney.com/api/qt/stock/details/sse';
      const params = new URLSearchParams({
        fields1: 'f1,f2,f3,f4',
        fields2: 'f51,f52,f53,f54,f55',
        mpi: '1000',
        ut: 'bd1d9ddb04089700cf9c27f6f7426281',
        fltt: '2',
        pos: '-0',
        secid: `${marketCode}.${symbol}`,
        wbp2u: '|0|0|0|web'
      });

      showCurl('tick-curl', url, params);
      showLoading('tick-result');

      try {
        const response = await fetch(`${url}?${params}`);
        const text = await response.text();
        
        // å¤„ç† SSE æ ¼å¼
        const lines = text.split('\n').filter(line => line.startsWith('data: '));
        if (lines.length === 0) {
          throw new Error('æ— æ•°æ®è¿”å›');
        }

        const jsonStr = lines[0].replace('data: ', '');
        const data = JSON.parse(jsonStr);
        
        if (!data.data?.details) {
          throw new Error('æ— æˆäº¤æ˜ç»†æ•°æ®');
        }

        const details = data.data.details.slice(0, 20).map(item => {
          const [time, price, volume, , type] = item.split(',');
          return {
            æ—¶é—´: time,
            æˆäº¤ä»·: parseFloat(price),
            æ‰‹æ•°: parseInt(volume),
            ä¹°å–ç›˜æ€§è´¨: type === '2' ? 'ä¹°ç›˜' : type === '1' ? 'å–ç›˜' : 'ä¸­æ€§ç›˜'
          };
        });

        const result = {
          æœ€è¿‘20ç¬”æˆäº¤: details,
          æ€»ç¬”æ•°: data.data.details.length,
          åŸå§‹æ•°æ®: data.data
        };

        showResult('tick-result', result);
      } catch (error) {
        showResult('tick-result', { error: error.message }, true);
      }
    }

    // ç»¼åˆæµ‹è¯•
    async function testAll() {
      const resultEl = document.getElementById('all-result');
      resultEl.className = 'result';
      resultEl.innerHTML = '<div class="loading">â³ è¿è¡Œæ‰€æœ‰æµ‹è¯•...</div>';

      const results = {
        ç›˜å£æ•°æ®: 'æµ‹è¯•ä¸­...',
        èµ„é‡‘æµå‘: 'æµ‹è¯•ä¸­...',
        æˆäº¤æ˜ç»†: 'æµ‹è¯•ä¸­...'
      };

      try {
        await testBidAsk();
        results.ç›˜å£æ•°æ® = 'âœ… é€šè¿‡';
      } catch (e) {
        results.ç›˜å£æ•°æ® = 'âŒ å¤±è´¥: ' + e.message;
      }

      try {
        await testFundFlow();
        results.èµ„é‡‘æµå‘ = 'âœ… é€šè¿‡';
      } catch (e) {
        results.èµ„é‡‘æµå‘ = 'âŒ å¤±è´¥: ' + e.message;
      }

      try {
        await testTickData();
        results.æˆäº¤æ˜ç»† = 'âœ… é€šè¿‡';
      } catch (e) {
        results.æˆäº¤æ˜ç»† = 'âŒ å¤±è´¥: ' + e.message;
      }

      showResult('all-result', results);
    }
  </script>
</body>
</html>
