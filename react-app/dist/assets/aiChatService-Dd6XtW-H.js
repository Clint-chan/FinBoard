const f="https://market-api.newestgpt.com";function l(){try{const t=localStorage.getItem("market_board_auth");if(t)return JSON.parse(t).token||null}catch{}return null}async function k(){const t=l();if(!t)return{quota:3,used:0,remaining:3,isAdmin:!1};const r=await fetch(`${f}/api/user/quota`,{headers:{Authorization:`Bearer ${t}`}});return r.ok?r.json():{quota:3,used:0,remaining:3,isAdmin:!1}}async function S(t,r,y,h="intraday",a){var d;const p=l(),o=await fetch(`${f}/api/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t,stockData:r,mode:h,token:p})});if(!o.ok){if(o.status===429){const s=await o.json();throw new Error(s.error||"今日 AI 使用次数已用完")}throw new Error(`AI API error: ${o.status}`)}const i=(d=o.body)==null?void 0:d.getReader();if(!i)throw new Error("No response body");const w=new TextDecoder;let c="";for(;;){const{done:s,value:m}=await i.read();if(s)break;const g=w.decode(m,{stream:!0}).split(`
`).filter(n=>n.trim());for(const n of g)if(n.startsWith("data: ")){const u=n.slice(6);if(u==="[DONE]")continue;try{const e=JSON.parse(u);if(e.content&&(c+=e.content,a==null||a(e.content)),e.error)throw new Error(e.error)}catch(e){console.error("Parse error:",e)}}}return c}export{k as getUserQuota,S as sendChatMessage};
